#!/usr/bin/env bash

set -e
set -x

replace_in_database_yml() {
  if [[ "$DB" == "postgresql" ]]; then
    sed -i.bck "/^  adapter:/a \ \ $1:  $2" config/database.yml
  elif [[ "$DB" == "mysql" ]]; then
    sed -i.bck "s/^  $1:.*/\ \ $1: $2/" config/database.yml
  fi

  test -f config/database.yml.bck && rm -f config/database.yml.bck
}

# Stay away from the bundler env of the containing extension.
function unbundled {
  set +x
  ruby -rbundler -e'Bundler.with_unbundled_env { system *ARGV }' -- "$@"
}

# "sqlite" is set by the ORB extension instead of "sqlite3",
# all other options are already in the format expected by `rails new`.
test "$DB" = "sqlite" && export DB="sqlite3"

# Remove some noise generated by bundler
export BUNDLE_SUPPRESS_INSTALL_USING_MESSAGES=true

rm -rf ./sandbox
rails_version=`bundle exec ruby -e'require "rails"; puts Rails.version'`
rails _${rails_version}_ new sandbox \
  --skip-git \
  --database=${DB:-sqlite3} \
  --skip-rc

if [ ! -d "sandbox" ]; then
  echo 'sandbox rails application failed'
  exit 1
fi

cd ./sandbox

# Coverage
echo "require_relative '../../coverage.rb' if ENV['COVERAGE']" >> config/boot.rb
echo "gem 'rspec_junit_formatter', require: false" >> Gemfile
echo "gem 'simplecov', '~> 0.22', require: false" >> Gemfile
echo "gem 'simplecov-cobertura', require: false" >> Gemfile
unbundled bundle install

test -n "${host}" && replace_in_database_yml "host" "${host}"
test -n "${username}" && replace_in_database_yml "username" "${username}"
test -n "${password}" && replace_in_database_yml "password" "${password}"

unbundled bundle add solidus \
  --github "${SOLIDUS_REPO:-solidusio/solidus}" \
  --branch "${SOLIDUS_BRANCH:-main}" \
  --version '> 0.a'

unbundled bundle exec rake db:drop db:create

export FRONTEND="$PWD/../template.rb"
unbundled bundle exec rails generate solidus:install --auto-accept "$@"

echo
echo "ðŸš€ Sandbox app successfully created for ${extension_name}!"
echo "ðŸš€ Use 'export DB=[postgres|mysql|sqlite3]' to control the DB adapter"
echo "ðŸš€ This app is intended for test purposes."
